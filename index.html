<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#111827" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Universal Scanner ‚Äî Camera & HID</title>
<style>
  :root{--bg:#0b1020;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--radius:18px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 50% -10%,#1f2937 0%,var(--bg) 60%);color:var(--text);-webkit-tap-highlight-color:transparent}
  .container{max-width:720px;margin:0 auto;padding:16px 16px 24px;display:flex;flex-direction:column;gap:14px}

  /* Top display (camera preview) */
  #displayBox{
    height:20vh;min-height:140px;max-height:220px;width:100%;
    border-radius:16px;overflow:hidden;border:2px solid rgba(255,255,255,.08);
    background:#030712;display:grid;place-items:center;position:relative
  }
  #displayBox .placeholder{color:var(--muted);font-size:1.05rem;text-align:center;padding:0 12px}
  #displayBox video{width:100%;height:100%;object-fit:cover;display:block}
  #displayLabel{
    position:absolute;left:10px;top:10px;padding:4px 8px;border-radius:10px;
    background:rgba(17,24,39,.7);border:1px solid rgba(255,255,255,.12);
    font-size:.8rem;color:var(--text);backdrop-filter:blur(6px)
  }

  header{display:flex;align-items:center;gap:12px}
  header .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#1e293b,#0ea5e9);display:grid;place-items:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  header h1{font-size:1.1rem;margin:0} header p{margin:2px 0 0;color:var(--muted);font-size:.95rem}

  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.15));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}

  .tabs{display:flex;gap:10px;margin-bottom:8px}
  .tab{flex:1;text-align:center;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--text);font-weight:600;cursor:pointer;user-select:none;outline:2px solid transparent}
  .tab[aria-selected="true"]{outline:2px solid var(--accent);background:#0b1226}

  /* Global status + global result */
  #globalStatus{margin:0 2px;color:var(--muted);font-size:.95rem;min-height:1.2em}
  .row{display:flex;gap:10px;align-items:center;margin:6px 0 12px}
  .row .label{min-width:120px;flex:0 0 auto;color:var(--muted);font-size:.95rem}
  .row input[type="text"]{flex:1;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--text);font-size:1.05rem}

  /* Panels */
  #cameraPanel,#hidPanel{display:none}.panel-active{display:block}

  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
  button.secondary{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0f172a;color:var(--text);font-weight:700;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  .status{font-size:.9rem;color:var(--muted);margin:6px 2px;min-height:1.1em}
  input[type="text"]{width:100%;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--text)}
</style>
</head>
<body>
  <div class="container">
    <!-- Camera preview box (hidden in HID mode) -->
    <div id="displayBox" aria-live="polite">
      <div id="displayLabel">no input</div>
      <div class="placeholder" id="displayPlaceholder">select an input</div>
      <!-- video injected here -->
    </div>

    <header>
      <div class="logo" aria-hidden="true">üéõÔ∏è</div>
      <div>
        <h1>Universal Scanner ‚Äî Camera & HID</h1>
        <p>Use Camera or a connected barcode scanner. Live view appears above in camera mode.</p>
      </div>
    </header>

    <div class="card" role="region" aria-label="Scanner">
      <div class="tabs" role="tablist">
        <div class="tab" id="tab-camera" role="tab" aria-selected="false" aria-controls="cameraPanel">Camera</div>
        <div class="tab" id="tab-hid" role="tab" aria-selected="false" aria-controls="hidPanel">Barcode Scanner (HID)</div>
      </div>

      <div id="globalStatus">Select an input.</div>
      <div class="row">
        <div class="label">Scan result</div>
        <input id="resultBox" type="text" placeholder="Waiting for a scan‚Ä¶" readonly />
      </div>

      <!-- CAMERA -->
      <section id="cameraPanel" role="tabpanel" aria-labelledby="tab-camera">
        <div class="controls">
          <button id="btnPerm" class="secondary">Request permission</button>
          <button id="btnFlip" class="secondary" disabled>Flip camera</button>
        </div>
        <div class="status" id="status">Choose Camera to start.</div>
      </section>

      <!-- HID -->
      <section id="hidPanel" role="tabpanel" aria-labelledby="tab-hid">
        <div class="status">HID mode: type or scan ‚Äî field focus not required.</div>
        <input id="hidInput" type="text" autocomplete="off" spellcheck="false" placeholder="(Optional) click here, then scan‚Ä¶" />
        <div class="controls">
          <button id="btnClearHid" class="secondary">Clear</button>
          <label class="status"><input type="checkbox" id="hidAuto" checked /> Auto-detect pause</label>
        </div>
        <div class="status" id="typeStatus"></div>
      </section>
    </div>
  </div>

  <!-- Self-hosted ZXing (keep this file next to index.html) -->
  <script src="./zxing.min.js" defer></script>

  <script>
    const $ = s => document.querySelector(s);

    // UI elements
    const displayBox = $('#displayBox');
    const displayLabel = $('#displayLabel');
    const displayPlaceholder = $('#displayPlaceholder');
    const globalStatus = $('#globalStatus');
    const resultBox = $('#resultBox');
    const statusEl = $('#status');

    const tabCamera = $('#tab-camera'), tabHid = $('#tab-hid');
    const cameraPanel = $('#cameraPanel'), hidPanel = $('#hidPanel');
    const btnPerm = $('#btnPerm'), btnFlip = $('#btnFlip');

    const hidInput = $('#hidInput'), hidAuto = $('#hidAuto'), btnClearHid = $('#btnClearHid'), typeStatus = $('#typeStatus');

    // Helpers
    const setStatus = (msg)=>{ globalStatus.innerHTML = msg; if (cameraPanel.classList.contains('panel-active')) statusEl.innerHTML = msg; };
    const showDisplayBox = (show)=>{ displayBox.style.display = show ? 'grid' : 'none'; };

    // Camera state
    let videoEl=null, currentStream=null, cameras=[], camIndex=-1, cameraRunning=false, decoding=false;

    function showMessage(msg, label='no input'){
      const v = displayBox.querySelector('video'); if (v) v.remove();
      displayPlaceholder.textContent = msg; displayPlaceholder.style.display = 'block';
      displayLabel.textContent = label;
    }
    async function showVideo(stream, label='camera'){
      displayPlaceholder.style.display = 'none'; displayLabel.textContent = label;
      if (!videoEl){ videoEl = document.createElement('video'); videoEl.setAttribute('playsinline',''); videoEl.muted=true; videoEl.autoplay=true; videoEl.style.width='100%'; videoEl.style.height='100%'; videoEl.style.objectFit='cover'; }
      else if (videoEl.parentElement){ videoEl.parentElement.removeChild(videoEl); }
      videoEl.srcObject = stream; displayBox.appendChild(videoEl);
      try { await videoEl.play(); } catch(e){ setStatus(`Tap Camera again if video didn't start: ${e.message}`); }
    }

    // Init
    showMessage('select an input','no input'); setStatus('Select an input.');

    function setTabs(cameraSelected){
      tabCamera.setAttribute('aria-selected', cameraSelected);
      tabHid.setAttribute('aria-selected', !cameraSelected);
      cameraPanel.classList.toggle('panel-active', cameraSelected);
      hidPanel.classList.toggle('panel-active', !cameraSelected);
    }

    // HID robust capture (works even without focus)
    let hidModeActive=false, hidBuffer='', hidTimer=null; const HID_COMMIT_MS=120;
    function updateHidEcho(buf){ typeStatus.textContent = buf ? '‚å®Ô∏è Typing‚Ä¶' : ''; resultBox.value = buf; }
    function commitHid(buf){ if(!buf) return; resultBox.value = buf; typeStatus.textContent='Read complete'; setStatus('HID: Read complete'); hidInput && hidInput.select(); }
    document.addEventListener('keydown', (e)=>{
      if(!hidModeActive) return;
      if(e.ctrlKey || e.metaKey || e.altKey || e.key==='Shift') return;
      if(e.key==='Enter' || e.key==='Tab'){ e.preventDefault(); const buf=hidBuffer; hidBuffer=''; commitHid(buf); return; }
      if(e.key==='Backspace'){ hidBuffer = hidBuffer.slice(0,-1); updateHidEcho(hidBuffer); return; }
      if(e.key.length===1){ hidBuffer += e.key; updateHidEcho(hidBuffer); if(hidAuto && hidAuto.checked){ clearTimeout(hidTimer); hidTimer=setTimeout(()=>{ const b=hidBuffer; hidBuffer=''; commitHid(b); }, HID_COMMIT_MS); } }
    });
    hidInput && hidInput.addEventListener('input', ()=>{
      if(!hidModeActive) return;
      hidBuffer = hidInput.value; updateHidEcho(hidBuffer);
      if(hidAuto && hidAuto.checked){ clearTimeout(hidTimer); hidTimer=setTimeout(()=>{ const b=hidBuffer; hidBuffer=''; commitHid(b); }, HID_COMMIT_MS); }
    });
    btnClearHid && btnClearHid.addEventListener('click', ()=>{ hidBuffer=''; hidInput.value=''; resultBox.value=''; typeStatus.textContent=''; setStatus('HID: cleared.'); });

    // Tabs
    tabCamera.addEventListener('click', async ()=>{
      const already = tabCamera.getAttribute('aria-selected')==='true';
      hidModeActive = false; showDisplayBox(true);
      if (already){
        if (cameraRunning){ await stopCamera(); showMessage('camera stopped','camera'); setStatus('Camera stopped.'); }
        else { await startCamera(); }
        return;
      }
      setTabs(true);
      await startCamera();
    });
    tabHid.addEventListener('click', ()=>{
      stopCamera(); showDisplayBox(false);
      setTabs(false);
      setStatus('HID ready ‚Äî type/scan now.');
      hidModeActive = true; hidBuffer=''; typeStatus.textContent=''; hidInput.value=''; hidInput.focus();
    });

    // Camera plumbing
    async function listCameras(){
      try { const devices = await navigator.mediaDevices.enumerateDevices(); cameras = devices.filter(d=>d.kind==='videoinput'); if (camIndex<0 && cameras.length) camIndex=0; } catch { cameras=[]; }
    }
    async function startCamera(){
      setStatus('Requesting camera‚Ä¶');
      try{
        const constraints = { video:{ facingMode:{ ideal:'environment' }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false };
        const warm = await navigator.mediaDevices.getUserMedia(constraints); warm.getTracks().forEach(t=>t.stop());
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        await attachStream(stream); await listCameras(); btnFlip && (btnFlip.disabled = !(cameras && cameras.length>=2));
        cameraRunning=true; startDecodingLoop();
      }catch(e){ setStatus(`<span style="color:#ef4444">Camera error:</span> ${e.message||e}`); cameraRunning=false; }
    }
    async function attachStream(stream){
      try{ if(currentStream) currentStream.getTracks().forEach(t=>t.stop()); }catch{}
      currentStream=stream; await showVideo(stream,'camera'); setStatus('Camera running ‚Äî align the barcode.');
    }
    async function stopCamera(){
      try{ if(currentStream){ currentStream.getTracks().forEach(t=>t.stop()); } }catch{}
      currentStream=null; if(videoEl){ try{ videoEl.pause(); }catch{} if(videoEl.parentElement) videoEl.parentElement.removeChild(videoEl); }
      cameraRunning=false; decoding=false;
    }
    btnPerm && btnPerm.addEventListener('click', async ()=>{
      setStatus('Requesting camera permission‚Ä¶');
      try{ const s=await navigator.mediaDevices.getUserMedia({video:true,audio:false}); s.getTracks().forEach(t=>t.stop()); await listCameras(); btnFlip && (btnFlip.disabled=!(cameras&&cameras.length>=2)); setStatus('Permission granted. Choose Camera.'); }
      catch(e){ setStatus(`<span style="color:#ef4444">Permission denied:</span> ${e.message||e}`); }
    });
    btnFlip && btnFlip.addEventListener('click', async ()=>{
      if(!cameras || cameras.length<2) return;
      try{ camIndex=(camIndex+1)%cameras.length; const id=cameras[camIndex].deviceId; const s=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:id}},audio:false}); await attachStream(s); startDecodingLoop(); setStatus(`Switched camera (${cameras[camIndex].label||('camera '+(camIndex+1))})`); }
      catch(e){ setStatus(`<span style="color:#ef4444">Flip failed:</span> ${e.message||e}`); }
    });

    // Camera decoding (native first; ZXing core fallback with decodeWithState)
    let barcodeDetector=null, zxReader=null, zxHints=null;
    const SCAN_MS=150;
    async function waitForVideoReady(){
      const start=performance.now();
      while(cameraRunning && videoEl && (videoEl.videoWidth<2 || videoEl.videoHeight<2)){ await new Promise(r=>setTimeout(r,30)); if(performance.now()-start>3000) break; }
    }
    async function ensureBarcodeDetector(){
      if('BarcodeDetector' in window){
        try{ barcodeDetector = new window.BarcodeDetector({ formats:['ean_13','ean_8','upc_a','upc_e','code_128','code_39','itf','qr_code'] }); return true; }
        catch{ barcodeDetector=null; }
      }
      return false;
    }
    function ensureZxing(){
      const ZX=window.ZXing; if(!ZX) return false;
      if(!zxHints){ const H=ZX.DecodeHintType,F=ZX.BarcodeFormat; zxHints=new Map(); zxHints.set(H.TRY_HARDER,true); zxHints.set(H.POSSIBLE_FORMATS,[F.EAN_13,F.EAN_8,F.UPC_A,F.UPC_E,F.CODE_128,F.CODE_39,F.ITF,F.QR_CODE]); }
      if(!zxReader){ zxReader=new ZX.MultiFormatReader(); zxReader.setHints && zxReader.setHints(zxHints); }
      return true;
    }
    const scanCanvas=document.createElement('canvas'); const scanCtx=scanCanvas.getContext('2d',{willReadFrequently:true});
    function tryZX(x,y,w,h){
      const ZX=window.ZXing; if(!ensureZxing()||!videoEl||w<2||h<2) return null;
      scanCanvas.width=w; scanCanvas.height=h; scanCtx.drawImage(videoEl,x,y,w,h,0,0,w,h);
      const img=scanCtx.getImageData(0,0,w,h);
      try{
        const lum=new ZX.RGBLuminanceSource(img.data,w,h);
        const bmp=new ZX.BinaryBitmap(new ZX.HybridBinarizer(lum));
        const res=zxReader.decodeWithState(bmp); const text=res && (res.getText?res.getText():res.text);
        return text||null;
      }catch{ return null; } finally{ zxReader.reset && zxReader.reset(); }
    }
    async function startDecodingLoop(){
      if(!cameraRunning||!videoEl||decoding) return; decoding=true; await waitForVideoReady();
      let lastBeat=0;

      if(await ensureBarcodeDetector()){
        const tick=async()=>{ if(!decoding||!cameraRunning) return;
          try{ const res=await barcodeDetector.detect(videoEl); if(res&&res.length){ const v=res[0].rawValue||''; if(v){ resultBox.value=v; setStatus(`Detected (${res[0].format||'code'}) ‚Äî stopping‚Ä¶`); await stopCamera(); decoding=false; return; } } }catch{}
          const now=performance.now(); if(now-lastBeat>1500){ setStatus('Scanning‚Ä¶'); lastBeat=now; }
          setTimeout(tick,SCAN_MS);
        }; setTimeout(tick,SCAN_MS); return;
      }

      if(!ensureZxing()){ setStatus(`<span style="color:#ef4444">Decoder unavailable:</span> ZXing not found. Ensure zxing.min.js is present.`); decoding=false; return; }

      const tickZX=()=>{ if(!decoding||!cameraRunning) return;
        const vw=videoEl.videoWidth||1280, vh=videoEl.videoHeight||720;
        const cw=Math.round(vw*0.86), ch=Math.round(vh*0.34), cx=Math.round((vw-cw)/2), cy=Math.round((vh-ch)/2);
        let text=tryZX(cx,cy,cw,ch); if(!text) text=tryZX(0,0,vw,vh);
        if(text){ resultBox.value=text; setStatus('Detected ‚Äî stopping‚Ä¶'); stopCamera().then(()=>{decoding=false;}); return; }
        const now=performance.now(); if(now-lastBeat>1500){ setStatus('Scanning‚Ä¶'); lastBeat=now; }
        setTimeout(tickZX,SCAN_MS);
      }; setTimeout(tickZX,SCAN_MS);
    }

    // Background pause
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden){ decoding=false; stopCamera(); } });
  </script>
</body>
</html>