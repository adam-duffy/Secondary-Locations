<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<meta name="theme-color" content="#111827" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<title>Universal Scanner â€” Camera & HID (No Libs)</title>
<style>
  :root{--bg:#0b1020;--panel:#111827;--text:#e5e7eb;--muted:#9ca3af;--accent:#22d3ee;--warn:#f59e0b;--error:#ef4444;--radius:18px}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:radial-gradient(1200px 800px at 50% -10%,#1f2937 0%,var(--bg) 60%);color:var(--text);-webkit-tap-highlight-color:transparent}
  .container{max-width:720px;margin:0 auto;padding:16px 16px 28px}
  header{display:flex;align-items:center;gap:12px;padding:12px 0 16px}
  header .logo{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#1e293b,#0ea5e9);display:grid;place-items:center;box-shadow:0 8px 24px rgba(0,0,0,.35)}
  header h1{font-size:1.2rem;margin:0} header p{margin:2px 0 0;color:var(--muted);font-size:.95rem}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.15));border:1px solid rgba(255,255,255,.08);border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px}
  .tabs{display:flex;gap:10px;margin-bottom:10px}
  .tab{flex:1;text-align:center;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--text);font-weight:600;cursor:pointer;user-select:none}
  .tab[aria-selected="true"]{outline:2px solid var(--accent);background:#0b1226}
  #cameraPanel,#hidPanel{display:none}.panel-active{display:block}
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 12px}
  button.primary{flex:1;min-width:140px;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,#0ea5e9,#22d3ee);color:#001222;font-weight:800;cursor:pointer}
  button.secondary{padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.1);background:#0f172a;color:var(--text);font-weight:700;cursor:pointer}
  button:disabled{opacity:.5;cursor:not-allowed}
  #preview{width:100%;aspect-ratio:16/10;border-radius:14px;overflow:hidden;background:#030712;border:2px solid rgba(255,255,255,.06);display:grid;place-items:center}
  video{width:100%;height:100%;object-fit:cover}
  #preview.flash{animation:flash .6s ease-out}
  @keyframes flash{0%{box-shadow:0 0 0 0 rgba(34,211,238,0.9);border-color:#22d3ee}100%{box-shadow:0 0 0 12px rgba(34,211,238,0);border-color:rgba(255,255,255,.06)}}
  .status{font-size:.95rem;color:var(--muted);margin:6px 2px;min-height:1.2em}
  input[type="text"]{width:100%;padding:14px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.08);background:#0f172a;color:var(--text);font-size:1.05rem}
  .code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:1.05rem;background:#0b1226;border:1px dashed rgba(255,255,255,.18);border-radius:12px;padding:10px;margin-top:8px}
  footer{margin-top:22px;color:var(--muted);font-size:.85rem;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo" aria-hidden="true">ðŸ“·</div>
      <div>
        <h1>Universal Scanner â€” Camera & HID</h1>
        <p>Tabs now trigger actions: Camera auto-starts; HID focuses input.</p>
      </div>
    </header>

    <div class="card" role="region" aria-label="Scanner">
      <div class="tabs" role="tablist">
        <div class="tab" id="tab-camera" role="tab" aria-selected="true" aria-controls="cameraPanel">Camera</div>
        <div class="tab" id="tab-hid" role="tab" aria-selected="false" aria-controls="hidPanel">Barcode Scanner (HID)</div>
      </div>

      <section id="cameraPanel" class="panel-active" role="tabpanel" aria-labelledby="tab-camera">
        <div id="preview" aria-label="Live camera preview"><div style="opacity:.55">Camera preview will appear here</div></div>
        <div class="controls">
          <button id="btnStart" class="primary">Start camera</button>
          <button id="btnPerm" class="secondary">Request permission</button>
          <button id="btnStop" class="secondary" disabled>Stop</button>
          <button id="btnFlip" class="secondary" disabled>Flip camera</button>
        </div>
        <div class="status" id="status">Idle. Tap <strong>Start camera</strong>.</div>
      </section>

      <section id="hidPanel" role="tabpanel" aria-labelledby="tab-hid">
        <p class="status">HID mode: focus the box and scan/type.</p>
        <input id="hidInput" type="text" inputmode="none" autocomplete="off" spellcheck="false" placeholder="Click here, then scanâ€¦" />
        <div class="controls">
          <button id="btnClearHid" class="secondary">Clear</button>
          <label class="status"><input type="checkbox" id="hidAuto" checked /> Auto-detect when typing stops</label>
        </div>
        <div class="status" id="typeStatus"></div>
        <div class="code" id="hidEcho">No input yet.</div>
      </section>
    </div>

    <footer>
      <div>Tip: use HTTPS or localhost for camera access.</div>
      <div id="capabilities"></div>
    </footer>
  </div>

  <script>
    // ---------- Utilities ----------
    const $ = (s)=>document.querySelector(s);
    const statusEl = $('#status');
    const capsEl = $('#capabilities');
    const preview = $('#preview');
    const videoEl = document.createElement('video');
    videoEl.setAttribute('playsinline',''); // iOS inline playback
    let currentStream = null;
    let cameras = []; // list of videoinput devices
    let camIndex = -1;

    const secure = (location.protocol === 'https:' || location.hostname === 'localhost');
    const camCap = ('mediaDevices' in navigator && 'getUserMedia' in navigator.mediaDevices);
    capsEl.textContent = `${camCap ? 'ðŸŽ¥ Camera API' : 'ðŸš« No camera API'} Â· ${secure ? 'ðŸ”’ Secure' : 'âš ï¸ Not secure'} Â· âœ… JS running`;

    function setStatus(msg){ if(statusEl) statusEl.innerHTML = msg; }
    function flash(){ preview.classList.remove('flash'); void preview.offsetWidth; preview.classList.add('flash'); }

    // ---------- Tabs (now with actions) ----------
    const tabCamera = $('#tab-camera'), tabHid = $('#tab-hid');
    const cameraPanel = $('#cameraPanel'), hidPanel = $('#hidPanel');
    function activateTab(which){
      const cam = which==='camera';
      tabCamera.setAttribute('aria-selected', cam);
      tabHid.setAttribute('aria-selected', !cam);
      cameraPanel.classList.toggle('panel-active', cam);
      hidPanel.classList.toggle('panel-active', !cam);
      if (cam) {
        // Auto-start camera if not running
        if (!currentStream) startCamera();
      } else {
        // Stop camera, focus HID input, show ready state
        stopCamera();
        const inp = $('#hidInput');
        if (inp){ inp.focus(); }
        const ts = $('#typeStatus');
        if (ts){ ts.textContent = 'Ready â€” scan now'; }
      }
    }
    tabCamera.addEventListener('click', ()=>activateTab('camera'));
    tabHid.addEventListener('click', ()=>activateTab('hid'));

    // ---------- Camera core (no libs) ----------
    async function listCamerasAfterPermission(){
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        cameras = devices.filter(d=>d.kind==='videoinput');
        if (camIndex < 0 && cameras.length) camIndex = 0;
      } catch { cameras = []; }
    }

    function attachStream(stream){
      stopCamera(); // stop any previous
      currentStream = stream;
      videoEl.srcObject = stream;
      videoEl.autoplay = true;
      videoEl.muted = true;
      preview.innerHTML = '';
      preview.appendChild(videoEl);
    }

    async function startCamera(){
      flash();
      setStatus('Start clicked âœ“ â€” requesting cameraâ€¦');
      $('#btnStart').disabled = true; $('#btnStart').textContent = 'Startingâ€¦';

      if (!camCap){ setStatus('<span style="color:#ef4444">Camera API not supported in this browser.</span>'); $('#btnStart').disabled=false; $('#btnStart').textContent='Start camera'; return; }
      if (!secure){ setStatus('<span style="color:#f59e0b">Tip:</span> Use HTTPS or localhost â€” many browsers block camera on HTTP.'); }

      try{
        // Prefer rear camera; desktop may ignore facingMode
        const constraints = { video: { facingMode: { ideal: 'environment' } }, audio:false };
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        attachStream(stream);
        setStatus('Camera running â€” live preview above.');
        $('#btnStop').disabled = false;

        await listCamerasAfterPermission();
        $('#btnFlip').disabled = !(cameras && cameras.length >= 2);
      }catch(e){
        setStatus(`<span style="color:#ef4444">Camera error:</span> ${e.message || e}`);
        $('#btnStart').disabled=false; $('#btnStart').textContent='Start camera';
      }
    }

    async function stopCamera(){
      try{ if (currentStream){ currentStream.getTracks().forEach(t=>t.stop()); } }catch{}
      currentStream = null;
      $('#btnStart').disabled = false; $('#btnStart').textContent = 'Start camera';
      $('#btnStop').disabled = true;
      // keep Flip state
    }

    async function flipCamera(){
      if (!cameras || cameras.length < 2) return;
      try{
        camIndex = (camIndex + 1) % cameras.length;
        const deviceId = cameras[camIndex].deviceId;
        const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } }, audio:false });
        attachStream(stream);
        setStatus(`Switched camera (${cameras[camIndex].label || 'camera ' + (camIndex+1)})`);
      }catch(e){
        setStatus(`<span style="color:#ef4444">Flip failed:</span> ${e.message || e}`);
      }
    }

    // ---------- HID typing (proof of wiring) ----------
    const hidInput = $('#hidInput');
    const hidAuto = $('#hidAuto');
    const btnClearHid = $('#btnClearHid');
    const typeStatus = $('#typeStatus');
    const hidEcho = $('#hidEcho');
    let typeTimer=null; const DONE_GAP_MS=120;

    function doneTyping(){
      const text=(hidInput.value||'').trim();
      if(!text) return;
      if(typeStatus) typeStatus.textContent='Read complete';
      if(hidEcho) hidEcho.textContent = text;
      hidInput.select();
    }
    hidInput.addEventListener('keydown', (e)=> {
      if(typeStatus) typeStatus.textContent='âŒ¨ï¸ Key press detected';
      if(e.key==='Enter' || e.key==='Tab'){ e.preventDefault(); doneTyping(); }
    });
    hidInput.addEventListener('input', ()=> {
      if(typeStatus) typeStatus.textContent='âŒ¨ï¸ Typingâ€¦';
      if(hidEcho) hidEcho.textContent = hidInput.value;
      if(!hidAuto.checked) return;
      clearTimeout(typeTimer); typeTimer=setTimeout(doneTyping, DONE_GAP_MS);
    });
    btnClearHid.addEventListener('click', ()=>{ hidInput.value=''; hidInput.focus(); if(typeStatus) typeStatus.textContent=''; if(hidEcho) hidEcho.textContent='No input yet.'; });

    // ---------- Buttons ----------
    $('#btnStart').addEventListener('click', startCamera);
    $('#btnStop').addEventListener('click', stopCamera);
    $('#btnFlip').addEventListener('click', flipCamera);
    $('#btnPerm').addEventListener('click', async ()=>{
      setStatus('Requesting camera permissionâ€¦');
      try{
        const s = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        s.getTracks().forEach(t=>t.stop());
        setStatus('Permission granted. Tap Start camera.');
        await listCamerasAfterPermission();
        $('#btnFlip').disabled = !(cameras && cameras.length >= 2);
      }catch(e){
        setStatus(`<span style="color:#ef4444">Permission denied:</span> ${e.message || e}`);
      }
    });

    // Show unexpected JS errors instead of â€œnothing happensâ€
    window.addEventListener('error', (e)=>{
      setStatus('<span style="color:#ef4444">JavaScript error:</span> ' + (e && e.message ? e.message : e));
    });

    // Stop camera when backgrounded
    document.addEventListener('visibilitychange', ()=>{ if(document.hidden) stopCamera(); });
  </script>
</body>
</html>
